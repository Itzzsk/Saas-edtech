<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard - Smart Attendance</title>

<link rel="icon" type="image/png" href="logo2.png" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
  :root {
    --glass-bg: rgba(255, 255, 255, 0.65);
    --glass-border: rgba(255, 255, 255, 0.4);
    --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05);
    --primary-color: #6366F1;
    --text-primary: #1E293B;
    --text-secondary: #64748B;
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  body {
    font-family: 'Poppins', sans-serif;
    /* Professional aesthetic gradient background */
    background: linear-gradient(135deg, #eef2f3 0%, #e0eafc 100%);
    background-size: 400% 400%;
    animation: gradientBG 15s ease infinite;
    display: flex;
    height: 100vh;
    overflow: hidden;
    color: var(--text-primary);
  }
  
  @keyframes gradientBG {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  /* Abstract Shapes for Depth */
  body::before {
    content: '';
    position: absolute;
    top: -10%;
    right: -5%;
    width: 600px;
    height: 600px;
    background: radial-gradient(circle, rgba(99, 102, 241, 0.08) 0%, transparent 70%);
    border-radius: 50%;
    filter: blur(60px);
    z-index: -1;
  }

  body::after {
    content: '';
    position: absolute;
    bottom: -10%;
    left: -5%;
    width: 500px;
    height: 500px;
    background: radial-gradient(circle, rgba(236, 72, 153, 0.08) 0%, transparent 70%);
    border-radius: 50%;
    filter: blur(60px);
    z-index: -1;
  }
  
  /* ========== GLASS SIDEBAR ========== */
  .sidebar {
    width: 70px;
    background: var(--glass-bg);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-right: 1px solid var(--glass-border);
    flex-direction: column;
    padding: 24px 0;
    display: flex;
    flex-shrink: 0;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
    position: relative;
    z-index: 1000;
    box-shadow: var(--glass-shadow);
  }
  
  .sidebar:hover {
    width: 260px;
    background: rgba(255, 255, 255, 0.85);
  }
  
  .logo-section {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 0 16px;
    margin-bottom: 40px;
  }
  
  .logo {
    width: 38px;
    height: 38px;
    border-radius: 12px;
    background: linear-gradient(135deg, #6366F1, #8B5CF6);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
  }
  
  .logo .material-symbols-rounded {
    color: white;
    font-size: 20px;
  }
  
  .brand-name {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary);
    white-space: nowrap;
    opacity: 0;
    transition: opacity 0.3s ease;
    letter-spacing: -0.3px;
  }
  
  .sidebar:hover .brand-name {
    opacity: 1;
    transition-delay: 0.1s;
  }
  
  .nav-menu {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 0 12px;
  }
  
  .nav-item {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 12px 14px;
    border-radius: 14px;
    cursor: pointer;
    text-decoration: none;
    color: var(--text-secondary);
    font-size: 13px;
    font-weight: 500;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  
  .nav-item .material-symbols-rounded {
    font-size: 22px;
    flex-shrink: 0;
    transition: color 0.3s ease;
  }
  
  .nav-item span:not(.material-symbols-rounded) {
    white-space: nowrap;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .sidebar:hover .nav-item span:not(.material-symbols-rounded) {
    opacity: 1;
    transition-delay: 0.1s;
  }
  
  .nav-item:hover {
    background: rgba(255, 255, 255, 0.6);
    color: var(--primary-color);
    transform: translateX(4px);
  }
  
  .nav-item.active {
    background: white;
    color: var(--primary-color);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
  }

  .nav-item.active .material-symbols-rounded {
    color: var(--primary-color);
  }
  
  .sidebar-footer {
    margin-top: auto;
    padding: 16px 12px 0;
  }
  
  .logout-btn {
    width: 100%;
    padding: 12px 14px;
    border-radius: 14px;
    background: transparent;
    color: #EF4444;
    border: 1px solid rgba(239, 68, 68, 0.1);
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 14px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    font-family: inherit;
    transition: all 0.3s;
  }
  
  .logout-btn:hover {
    background: rgba(239, 68, 68, 0.05);
    border-color: rgba(239, 68, 68, 0.3);
  }
  
  /* ========== MAIN CONTENT ========== */
  .main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
  }
  
  /* ========== HEADER ========== */
  .header {
    background: transparent;
    padding: 24px 32px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .page-title h1 {
    font-size: 26px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 4px;
    letter-spacing: -0.5px;
  }
  
  .page-title p {
    font-size: 13px;
    color: var(--text-secondary);
    font-weight: 500;
  }
  
  .header-actions {
    display: flex;
    align-items: center;
    gap: 16px;
  }
  
  .header-user-profile {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 6px 16px 6px 6px;
    background: var(--glass-bg);
    backdrop-filter: blur(12px);
    border: 1px solid white;
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
  }
  
  .header-user-profile:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
    background: rgba(255, 255, 255, 0.85);
  }
  
  .header-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, #6366F1, #8B5CF6);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 13px;
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.25);
  }
  
  .header-user-info {
    display: flex;
    flex-direction: column;
    gap: 1px;
  }
  
  .header-user-name {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-primary);
  }
  
  .header-user-email {
    font-size: 11px;
    color: var(--text-secondary);
  }
  
  /* ========== CONTENT AREA ========== */
  .content-area {
    flex: 1;
    overflow-y: auto;
    padding: 0 32px 32px;
  }
  
  /* ========== GLASS CARDS ========== */
  .glass-card {
    background: var(--glass-bg);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid white;
    border-radius: 20px;
    padding: 24px;
    box-shadow: var(--glass-shadow);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .glass-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.08);
  }

  .quick-actions-bar {
    background: rgba(255, 255, 255, 0.6);
    border: 1px solid white;
    border-radius: 20px;
    padding: 16px 24px;
    margin-bottom: 24px;
    box-shadow: var(--glass-shadow);
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
    backdrop-filter: blur(10px);
  }
  
  .quick-action-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 18px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 13px;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: 'Poppins', sans-serif;
  }
  
  .btn-primary {
    background: linear-gradient(135deg, #6366F1, #4F46E5);
    color: white;
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25);
  }
  
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(99, 102, 241, 0.35);
  }
  
  .btn-success {
    background: linear-gradient(135deg, #10B981, #059669);
    color: white;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
  }
  
  .btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(16, 185, 129, 0.35);
  }
  
  .btn-outline {
    background: white;
    color: var(--primary-color);
    border: 1px solid rgba(99, 102, 241, 0.1);
  }
  
  .btn-outline:hover {
    border-color: var(--primary-color);
    background: #F8FAFC;
  }
  
  /* ========== STATS GRID ========== */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 24px;
  }
  
  .stat-card {
    background: rgba(255, 255, 255, 0.7);
    border: 1px solid white;
    border-radius: 20px;
    padding: 20px;
    transition: all 0.3s ease;
    cursor: pointer;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.02);
  }
  
  .stat-card:hover {
    transform: translateY(-4px);
    background: white;
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.06);
  }
  
  .stat-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
  }
  
  .stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    transition: all 0.3s;
  }
  
  .stat-card:hover .stat-icon {
    transform: scale(1.1) rotate(5deg);
  }

  .stat-icon.blue { background: #EEF2FF; color: #6366F1; }
  .stat-icon.green { background: #ECFDF5; color: #10B981; }
  .stat-icon.red { background: #FEF2F2; color: #EF4444; }
  .stat-icon.orange { background: #FFFBEB; color: #F59E0B; }
  .stat-icon.purple { background: #F3E8FF; color: #8B5CF6; }
  .stat-icon.cyan { background: #ECFEFF; color: #06B6D4; }
  
  .stat-trend {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    font-weight: 700;
    padding: 6px 10px;
    border-radius: 20px;
  }
  
  .stat-trend.up { background: #D1FAE5; color: #059669; }
  .stat-trend.down { background: #FEE2E2; color: #EF4444; }
  
  .stat-title {
    font-size: 12px;
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }
  
  .stat-value {
    font-size: 32px;
    font-weight: 700;
    color: var(--text-primary);
    line-height: 1;
    margin-bottom: 4px;
  }
  
  .stat-subtitle {
    font-size: 12px;
    color: #94A3B8;
  }
  
  /* ========== CHARTS ========== */
  .charts-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 24px;
    margin-bottom: 24px;
  }
  
  .chart-card {
    background: rgba(255, 255, 255, 0.7);
    border: 1px solid white;
    border-radius: 20px;
    padding: 24px;
    box-shadow: var(--glass-shadow);
    transition: all 0.3s;
  }

  .chart-card:hover {
    background: white;
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.06);
  }
  
  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
  }
  
  .card-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
  }
  
  .card-subtitle {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 4px;
  }
  
  .time-filter {
    display: flex;
    gap: 4px;
    background: #F1F5F9;
    padding: 4px;
    border-radius: 12px;
  }
  
  .time-btn {
    padding: 6px 14px;
    border: none;
    background: transparent;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 600;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s;
    font-family: inherit;
  }
  
  .time-btn.active {
    background: white;
    color: var(--primary-color);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }
  
  .time-btn:hover:not(.active) {
    color: var(--text-primary);
  }
  
  .chart-container {
    position: relative;
    height: 280px;
  }
  
  /* ========== LISTS ========== */
  .analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 24px;
    margin-bottom: 24px;
  }
  
  .students-card {
    background: rgba(255, 255, 255, 0.7);
    border: 1px solid white;
    border-radius: 20px;
    padding: 24px;
    box-shadow: var(--glass-shadow);
  }
  
  .student-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 14px;
    background: white;
    border: 1px solid transparent;
    border-radius: 16px;
    margin-bottom: 12px;
    transition: all 0.2s;
    cursor: pointer;
  }
  
  .student-item:hover {
    border-color: #E2E8F0;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
    transform: translateX(4px);
  }
  
  .student-avatar {
    width: 42px;
    height: 42px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 14px;
    color: white;
    flex-shrink: 0;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  }
  
  .student-info {
    flex: 1;
  }
  
  .student-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 2px;
  }
  
  .student-details {
    font-size: 12px;
    color: var(--text-secondary);
  }
  
  .student-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
  }
  
  .badge-active {
    background: #ECFDF5;
    color: #059669;
  }
  
  .badge-pending {
    background: #FFFBEB;
    color: #D97706;
  }
  
  /* Activity Feed */
  .activity-item {
    display: flex;
    gap: 16px;
    padding: 14px;
    border-radius: 16px;
    margin-bottom: 10px;
    transition: all 0.2s;
    background: rgba(255, 255, 255, 0.5);
  }
  
  .activity-item:hover {
    background: white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
  }

  .activity-icon {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  
  /* Scrollbar */
  .content-area::-webkit-scrollbar {
    width: 6px;
  }
  .content-area::-webkit-scrollbar-track {
    background: transparent;
  }
  .content-area::-webkit-scrollbar-thumb {
    background: #CBD5E1;
    border-radius: 10px;
  }
  .content-area::-webkit-scrollbar-thumb:hover {
    background: #94A3B8;
  }
  
  /* Responsive */
  @media (max-width: 1000px) {
    .charts-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo-section">
      <div class="logo">
        <span class="material-symbols-rounded">school</span>
      </div>
      <div class="brand-name">Smart Attendance</div>
    </div>
    <nav class="nav-menu">
      <a href="dashboard.html" class="nav-item active">
        <span class="material-symbols-rounded">dashboard</span>
        <span>Dashboard</span>
      </a>
      <a href="students.html" class="nav-item">
        <span class="material-symbols-rounded">group</span>
        <span>Students</span>
      </a>
      <a href="report.html" class="nav-item">
        <span class="material-symbols-rounded">description</span>
        <span>Reports</span>
      </a>
      <a href="promotion.html" class="nav-item">
        <span class="material-symbols-rounded">trending_up</span>
        <span>Promote</span>
      </a>
      <a href="ai-assistant.html" class="nav-item">
        <span class="material-symbols-rounded">auto_awesome</span>
        <span>AI Assistant</span>
      </a>
    </nav>
    <div class="sidebar-footer">
      <button class="logout-btn" id="logoutBtn">
        <span class="material-symbols-rounded">logout</span>
        <span>Log Out</span>
      </button>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <div class="main-content">
    <header class="header">
      <div class="page-title">
        <h1>Dashboard Overview</h1>
        <p id="currentDate">Friday, October 25, 2025</p>
      </div>
      <div class="header-actions">
        <div class="header-user-profile">
          <div class="header-avatar" id="headerAvatar">AD</div>
          <div class="header-user-info">
            <div class="header-user-name" id="headerUserFullName">Admin User</div>
            <div class="header-user-email" id="headerUserEmail">admin@college.edu</div>
          </div>
        </div>
      </div>
    </header>

    <div class="content-area">
      <!-- QUICK ACTIONS -->
      <div class="quick-actions-bar">
        <div style="flex: 1; font-size: 13px; font-weight: 600; color: #64748B; text-transform: uppercase; letter-spacing: 0.5px;">Quick Actions</div>
        <button class="quick-action-btn btn-success" onclick="window.location.href='students.html'">
          <span class="material-symbols-rounded">add</span> Add Student
        </button>
        <button class="quick-action-btn btn-primary" onclick="window.location.href='view-attendance.html'">
          <span class="material-symbols-rounded">how_to_reg</span> Mark Attendance
        </button>
        <button class="quick-action-btn btn-outline" onclick="window.location.href='report.html'">
          <span class="material-symbols-rounded">download</span> Export Report
        </button>
      </div>

      <!-- STATS CARDS -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon blue"><span class="material-symbols-rounded">group</span></div>
            <div class="stat-trend up">
              <span class="material-symbols-rounded" style="font-size: 14px;">trending_up</span> 12%
            </div>
          </div>
          <div class="stat-title">Total Students</div>
          <div class="stat-value" id="totalStudents">-</div>
          <div class="stat-subtitle">+45 vs last month</div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon green"><span class="material-symbols-rounded">lan</span></div>
            <div class="stat-trend up">
               <span class="material-symbols-rounded" style="font-size: 14px;">trending_up</span> 6%
            </div>
          </div>
          <div class="stat-title">Active Streams</div>
          <div class="stat-value" id="totalStreams">-</div>
          <div class="stat-subtitle">All programs active</div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon orange"><span class="material-symbols-rounded">menu_book</span></div>
            <div class="stat-trend down">
               <span class="material-symbols-rounded" style="font-size: 14px;">trending_down</span> 2%
            </div>
          </div>
          <div class="stat-title">Total Subjects</div>
          <div class="stat-value" id="totalSubjects">-</div>
          <div class="stat-subtitle">Across all streams</div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon purple"><span class="material-symbols-rounded">check_circle</span></div>
             <div class="stat-trend up">
               <span class="material-symbols-rounded" style="font-size: 14px;">trending_up</span> 8%
            </div>
          </div>
          <div class="stat-title">Attendance Rate</div>
          <div class="stat-value"><span id="attendanceRate">-</span>%</div>
          <div class="stat-subtitle">Monthly average</div>
        </div>
      </div>

      <!-- CHARTS -->
      <div class="charts-grid">
        <div class="chart-card">
          <div class="card-header">
            <div>
              <div class="card-title">Attendance Trend</div>
              <div class="card-subtitle">Overview of student attendance</div>
            </div>
            <div class="time-filter">
              <button class="time-btn">Week</button>
              <button class="time-btn active">Month</button>
              <button class="time-btn">Year</button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="attendanceChart"></canvas>
          </div>
        </div>

        <div class="chart-card">
          <div class="card-header">
            <div>
              <div class="card-title">Stream Distribution</div>
              <div class="card-subtitle">Student enrollment by stream</div>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="streamChart"></canvas>
          </div>
        </div>
      </div>

      <!-- ACTIVITY & LISTS -->
      <div class="analytics-grid">
        <div class="students-card">
          <div class="card-header">
            <div class="card-title">Recent Students</div>
            <a href="students.html" style="font-size: 12px; color: #6366F1; font-weight: 600; text-decoration: none;">View All</a>
          </div>
          <div id="recentStudents">
            <!-- Content via JS -->
          </div>
        </div>
        
        <div class="students-card">
          <div class="card-header">
            <div class="card-title">Recent Activity</div>
          </div>
          <div id="recentActivity">
             <div class="activity-item">
               <div class="activity-icon blue"><span class="material-symbols-rounded" style="color:#6366F1">person_add</span></div>
               <div class="student-info">
                 <div class="student-name">New Registration</div>
                 <div class="student-details">John Doe joined BCA Sem 1</div>
               </div>
               <div class="student-details">2h ago</div>
             </div>
             <div class="activity-item">
               <div class="activity-icon green"><span class="material-symbols-rounded" style="color:#10B981">check_circle</span></div>
               <div class="student-info">
                 <div class="student-name">Attendance Marked</div>
                 <div class="student-details">BBA Sem 3 - 45 Present</div>
               </div>
               <div class="student-details">4h ago</div>
             </div>
          </div>
        </div>
      </div>
    </div>
  </div>


<!-- Firebase Auth Script -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { firebaseConfig } from './firebase-config.js';

  // ‚úÖ API Base URL


  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  window.firebaseAuth = auth;

  // Update current date
  function updateCurrentDate() {
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const today = new Date();
    const dateElement = document.getElementById('currentDate');
    if (dateElement) {
      dateElement.textContent = today.toLocaleDateString('en-US', options);
    }
  }
  updateCurrentDate();

  async function fetchTeacherProfile(email) {
    try {
      console.log('üë§ Fetching teacher profile for:', email);
      
      const response = await fetch(`${API_BASE_URL}/api/teacher/profile/email/${encodeURIComponent(email)}`, {
        headers: {
          'Cache-Control': 'no-cache',
          'Pragma': 'no-cache'
        }
      });
      
      if (!response.ok) {
        console.warn(`‚ö†Ô∏è Teacher profile fetch failed: ${response.status}`);
        return null;
      }
      
      const data = await response.json();
      
      if (data.success && data.teacher) {
        console.log('‚úÖ Teacher profile loaded:', data.teacher.name);
        return data.teacher;
      }
      
      console.warn('‚ö†Ô∏è Teacher profile not found in response');
      return null;
      
    } catch (error) {
      console.error('‚ùå Error fetching teacher profile:', error);
      return null;
    }
  }

  function getInitials(name, fallback = "IT") {
    if (!name || typeof name !== "string") return fallback;
    const parts = name.trim().split(" ").filter(Boolean);
    if (parts.length === 0) return fallback;
    return parts.map(n => n[0]).join("").substring(0, 2).toUpperCase();
  }

  function updateUserInfo(displayName, email) {
    console.log('üîÑ Updating user info:', { displayName, email });
    
    const fullNameEl = document.getElementById('headerUserFullName');
    const emailEl = document.getElementById('headerUserEmail');
    const avatarEl = document.getElementById('headerAvatar');
    
    if (fullNameEl) fullNameEl.textContent = displayName;
    if (emailEl) emailEl.textContent = email;
    
    const initials = getInitials(displayName);
    if (avatarEl) avatarEl.textContent = initials;
    
    console.log('‚úÖ User info updated');
  }

  // Logout handler
  const logoutBtn = document.getElementById("logoutBtn");
  if (logoutBtn) {
    logoutBtn.onclick = async function() {
      try {
        console.log('üö™ Logging out...');
        await signOut(auth);
        localStorage.clear();
        sessionStorage.clear();
        console.log('‚úÖ Logout successful');
        window.location.replace("login.html");
      } catch (error) {
        console.error('‚ùå Logout error:', error);
        // Force redirect anyway
        window.location.replace("login.html");
      }
    };
  }

  // Auth state observer
  onAuthStateChanged(auth, async (user) => {
    console.log('üîç Auth state changed:', user ? user.email : 'No user');
    
    if (user && user.email) {
      console.log('‚úÖ User authenticated:', user.email);
      
      // Generate display name from email
      let displayName = user.displayName || 
        user.email.split('@')[0]
          .replace(/[._]/g, ' ')
          .split(' ')
          .map(w => w.charAt(0).toUpperCase() + w.slice(1))
          .join(' ');
      
      // Try to fetch teacher profile
      const profile = await fetchTeacherProfile(user.email);
      if (profile && profile.name) {
        displayName = profile.name;
      }
      
      updateUserInfo(displayName, user.email);
      
      // Load dashboard data
      console.log('üìä Loading dashboard data...');
      loadDashboardData();
      
    } else {
      console.warn('‚ö†Ô∏è No user found, redirecting to login...');
      window.location.href = 'login.html';
    }
  });
</script>

<!-- Dashboard Core Script -->
<script>
  // ‚úÖ API Base URL
  const API_BASE_URL = 'http://localhost:5000';
  
  let attendanceChart, streamChart, todayAttendanceChart;

  function setVal(id, val) {
    const el = document.getElementById(id);
    if (el) {
      el.textContent = val ?? "-";
    }
  }

  function getInitials(name, fallback = "NA") {
    if (!name || typeof name !== "string") return fallback;
    const parts = name.trim().split(" ").filter(Boolean);
    if (parts.length === 0) return fallback;
    return parts.map(w => w[0]).join("").substring(0, 2).toUpperCase();
  }

  function initCharts() {
    console.log('üìä Initializing charts...');
    
    try {
      // Attendance Trend Chart
      const ctxLine = document.getElementById('attendanceChart');
      if (ctxLine) {
        attendanceChart = new Chart(ctxLine, {
          type: 'line',
          data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],
            datasets: [{
              label: 'Attendance %',
              data: [85, 88, 82, 90, 87, 91, 89],
              borderColor: '#6366F1',
              backgroundColor: 'rgba(99, 102, 241, 0.1)',
              tension: 0.4,
              fill: true,
              pointBackgroundColor: '#6366F1',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 4,
              pointHoverRadius: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: '#1E293B',
                padding: 12,
                borderRadius: 10,
                titleFont: { size: 13, weight: '600' },
                bodyFont: { size: 12 }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                ticks: { 
                  color: '#94A3B8', 
                  font: { size: 11 },
                  callback: function(value) {
                    return value + '%';
                  }
                },
                grid: { color: '#F1F5F9', drawBorder: false }
              },
              x: {
                ticks: { color: '#94A3B8', font: { size: 11 } },
                grid: { display: false, drawBorder: false }
              }
            }
          }
        });
      }

      // Stream Distribution Chart
      const ctxDoughnut = document.getElementById('streamChart');
      if (ctxDoughnut) {
        streamChart = new Chart(ctxDoughnut, {
          type: 'doughnut',
          data: {
            labels: ['BCA', 'BBA', 'BCOM'],
            datasets: [{
              data: [45, 30, 25],
              backgroundColor: ['#6366F1', '#10B981', '#F59E0B'],
              borderWidth: 0,
              hoverOffset: 8
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 16,
                  font: { size: 12, weight: '600' },
                  color: '#64748B',
                  usePointStyle: true,
                  pointStyle: 'circle'
                }
              },
              tooltip: {
                backgroundColor: '#1E293B',
                padding: 12,
                borderRadius: 10
              }
            }
          }
        });
      }

      // Today's Attendance Chart
      const ctxBar = document.getElementById('todayAttendanceChart');
      if (ctxBar) {
        todayAttendanceChart = new Chart(ctxBar, {
          type: 'bar',
          data: {
            labels: ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4', 'Sem 5', 'Sem 6'],
            datasets: [{
              label: 'Present',
              data: [42, 38, 45, 40, 36, 32],
              backgroundColor: '#10B981',
              borderRadius: 6
            }, {
              label: 'Absent',
              data: [8, 12, 5, 10, 14, 8],
              backgroundColor: '#EF4444',
              borderRadius: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  font: { size: 11, weight: '600' },
                  color: '#64748B',
                  usePointStyle: true,
                  pointStyle: 'circle',
                  padding: 12
                }
              },
              tooltip: {
                backgroundColor: '#1E293B',
                padding: 10,
                borderRadius: 8
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: { 
                  color: '#94A3B8', 
                  font: { size: 10 }
                },
                grid: { color: '#F1F5F9', drawBorder: false }
              },
              x: {
                ticks: { color: '#94A3B8', font: { size: 10 } },
                grid: { display: false, drawBorder: false }
              }
            }
          }
        });
      }
      
      console.log('‚úÖ Charts initialized successfully');
      
    } catch (error) {
      console.error('‚ùå Error initializing charts:', error);
    }
  }

  function loadRecentStudents(students) {
    const container = document.getElementById("recentStudents");
    
    if (!container) {
      console.warn('‚ö†Ô∏è Recent students container not found');
      return;
    }
    
    if (!Array.isArray(students) || students.length === 0) {
      container.innerHTML = '<p style="color:#94A3B8;text-align:center;padding:30px;font-size:12px;">No recent students found</p>';
      return;
    }
    
    const colors = ["#6366F1", "#10B981", "#F59E0B", "#EF4444", "#8B5CF6"];
    
    container.innerHTML = students.slice(0, 5).map((student, idx) => {
      const initials = student.name ? getInitials(student.name, "NA") : "NA";
      const badgeClass = student.isActive !== false ? "badge-active" : "badge-pending";
      const badgeText = student.isActive !== false ? "Active" : "Inactive";
      
      return `<div class="student-item">
        <div class="student-avatar" style="background:${colors[idx % colors.length]};">${initials}</div>
        <div class="student-info">
          <div class="student-name">${student.name || "Unknown"}</div>
          <div class="student-details">${student.stream || "N/A"} ‚Ä¢ Semester ${student.semester || "N/A"}</div>
        </div>
        <div class="student-badge ${badgeClass}">${badgeText}</div>
      </div>`;
    }).join("");
    
    console.log(`‚úÖ Loaded ${students.slice(0, 5).length} recent students`);
  }

  async function loadDashboardData() {
    console.log('üìä Loading dashboard data...');
    
    // Set loading state
    setVal("totalStudents", "...");
    setVal("totalStreams", "...");
    setVal("totalSubjects", "...");
    setVal("attendanceRate", "...");
    setVal("presentToday", "...");
    setVal("absentToday", "...");
    
    try {
      const timestamp = new Date().getTime();
      const res = await fetch(`${API_BASE_URL}/api/dashboard/stats?t=${timestamp}`, {
        headers: {
          'Cache-Control': 'no-cache, no-store, must-revalidate',
          'Pragma': 'no-cache',
          'Expires': '0'
        }
      });
      
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      }
      
      const data = await res.json();
      console.log('üì¶ Dashboard data received:', data);
      
      if (data.success && data.stats) {
        const stats = data.stats;
        
        setVal("totalStudents", stats.totalStudents ?? 0);
        setVal("totalStreams", stats.totalStreams ?? 0);
        setVal("totalSubjects", stats.totalSubjects ?? 0);
        setVal("attendanceRate", (stats.attendanceRate ?? 0) + '%');
        setVal("presentToday", stats.presentToday || 0);
        setVal("absentToday", stats.absentToday || 0);
        
        loadRecentStudents(stats.recentStudents || []);
        
        console.log('‚úÖ Dashboard data loaded successfully');
        
      } else {
        throw new Error(data.error || 'Failed to load dashboard stats');
      }
      
    } catch (error) {
      console.error('‚ùå Error loading dashboard data:', error);
      
      setVal("totalStudents", "Error");
      setVal("totalStreams", "Error");
      setVal("totalSubjects", "Error");
      setVal("attendanceRate", "Error");
      
      const container = document.getElementById("recentStudents");
      if (container) {
        container.innerHTML = `<p style="color:#EF4444;text-align:center;padding:30px;font-size:12px;">
          Error loading data<br>
          <small style="color:#94A3B8;font-size:11px;">${error.message}</small>
        </p>`;
      }
    }
  }

  // Initialize charts when DOM is ready
  window.addEventListener('load', () => {
    console.log('üöÄ Window loaded, initializing charts...');
    initCharts();
  });
</script>

</body>
</html>