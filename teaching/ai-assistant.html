<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>AI Assistant</title>
  
  <link rel="icon" type="image/png" href="logo2.png" />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
  <script src="https://cdn.jsdelivr.net/npm/marked@11.0.0/lib/marked.umd.js"></script>

  <style>
    :root {
      --primary: #6366F1;
      --bg: #F8FAFC;
      --text: #1E293B;
      --text-light: #64748B;
      --safe-bottom: env(safe-area-inset-bottom, 20px);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg);
      height: 100dvh; 
      width: 100vw;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      color: var(--text);
    }

    /* BACKGROUND */
    .ambient-bg {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: radial-gradient(circle at 100% 0%, rgba(99,102,241,0.08), transparent 40%),
                  radial-gradient(circle at 0% 100%, rgba(139,92,246,0.08), transparent 40%);
      z-index: -1; pointer-events: none;
    }

    /* HEADER - MOBILE ONLY */
    .app-header {
      padding: 16px 20px;
      display: flex; align-items: center; justify-content: space-between;
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      z-index: 50; border-bottom: 1px solid rgba(0,0,0,0.03);
    }

    .header-title { font-size: 20px; font-weight: 700; color: var(--text); }
    
    .profile-btn {
      width: 36px; height: 36px; border-radius: 12px;
      background: linear-gradient(135deg, #6366F1, #8B5CF6);
      color: white; display: flex; align-items: center; justify-content: center;
      font-weight: 600; font-size: 14px;
      box-shadow: 0 4px 12px rgba(99,102,241,0.25);
    }

    /* CHAT VIEW */
    .chat-view {
      flex: 1; position: relative; display: flex; flex-direction: column; overflow: hidden;
    }

    /* WELCOME SCREEN */
    .welcome-screen {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 30px; z-index: 10; transition: opacity 0.3s ease;
    }

    .welcome-icon {
      width: 80px; height: 80px; background: white; border-radius: 24px;
      display: flex; align-items: center; justify-content: center;
      margin-bottom: 20px; box-shadow: 0 15px 35px -5px rgba(99,102,241,0.15);
      animation: float 4s ease-in-out infinite;
    }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }

    .welcome-icon span { font-size: 40px; color: var(--primary); }
    .welcome-text h2 { font-size: 24px; font-weight: 700; margin-bottom: 8px; text-align: center; }
    .welcome-text p { font-size: 15px; color: var(--text-light); text-align: center; margin-bottom: 30px; }

    /* SUGGESTIONS */
    .suggestions-scroll {
      display: flex; gap: 12px; overflow-x: auto; width: 100%;
      padding: 4px 4px 20px 4px; scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch; scrollbar-width: none;
    }
    .suggestions-scroll::-webkit-scrollbar { display: none; }

    .suggestion-chip {
      flex: 0 0 auto; background: white; padding: 12px 16px; border-radius: 16px;
      border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 4px 10px rgba(0,0,0,0.03);
      display: flex; align-items: center; gap: 8px;
      font-size: 13px; font-weight: 500; color: var(--text);
      cursor: pointer;
      scroll-snap-align: center; transition: transform 0.1s;
    }
    .suggestion-chip:active { transform: scale(0.96); }
    .suggestion-chip:hover { background: #f1f5f9; }
    .suggestion-chip span { font-size: 18px; color: var(--primary); }

    /* MESSAGES LIST */
    .messages-list {
      flex: 1; overflow-y: auto;
      /* Mobile default: large bottom padding for floating input */
      padding: 20px 16px 180px 16px; 
      display: flex; flex-direction: column; gap: 24px;
      opacity: 0; pointer-events: none; transition: opacity 0.3s;
      scrollbar-width: none;
    }
    .messages-list.active { opacity: 1; pointer-events: all; }
    .messages-list::-webkit-scrollbar { display: none; }

    .msg { width: 100%; animation: slideUp 0.3s ease-out; }
    @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* BUBBLES */
    .msg-user { display: flex; justify-content: flex-end; }
    .msg-user .bubble {
      background: linear-gradient(135deg, #1E293B, #334155);
      color: white; padding: 12px 18px;
      border-radius: 20px 20px 4px 20px;
      font-size: 15px; max-width: 85%;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .msg-ai { display: flex; width: 100%; }
    .msg-ai .bubble {
      background: white; color: var(--text);
      width: 100%;
      padding: 16px;
      border-radius: 16px;
      font-size: 15px; line-height: 1.6;
      box-shadow: 0 2px 10px rgba(0,0,0,0.03);
      border: 1px solid rgba(0,0,0,0.05);
    }

    /* MARKDOWN */
    .msg-ai strong { color: var(--primary); font-weight: 600; }
    .msg-ai ul { padding-left: 20px; margin: 8px 0; }
    .msg-ai li { margin-bottom: 4px; }
    .msg-ai table { 
      width: 100%; display: block; overflow-x: auto; 
      border-collapse: collapse; margin: 12px 0; 
      font-size: 13px; white-space: nowrap;
    }
    .msg-ai th, .msg-ai td { padding: 10px 12px; border-bottom: 1px solid #eee; text-align: left; }
    .msg-ai th { font-weight: 600; color: var(--text-light); background: #f9fafb; }

    /* INPUT BAR - MOBILE (Floating) */
    .input-container {
      position: absolute; 
      bottom: 100px; /* Lifted for mobile nav */
      left: 16px; right: 16px;
      z-index: 100; transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    .input-box {
      background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.5); border-radius: 30px;
      padding: 6px 6px 6px 20px; display: flex; align-items: center; gap: 10px;
      box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1);
    }
    .input-box:focus-within { transform: translateY(-2px); box-shadow: 0 15px 40px -5px rgba(99,102,241,0.15); border-color: var(--primary); }

    .input-field {
      flex: 1; border: none; background: transparent;
      font-size: 16px; color: var(--text); padding: 12px 0; outline: none; font-family: inherit;
    }
    .send-btn {
      width: 44px; height: 44px; border-radius: 50%;
      background: var(--text); color: white; border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center; transition: transform 0.2s;
    }
    .send-btn:active { transform: scale(0.9); }

    /* BOTTOM NAV - MOBILE ONLY */
    .bottom-nav {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      padding: 12px 20px calc(12px + env(safe-area-inset-bottom, 0px));
      display: flex; align-items: center; justify-content: space-around;
      gap: 8px;
      box-shadow: 0 -10px 40px rgba(0,0,0,0.05);
      border-top: 1px solid rgba(255, 255, 255, 0.6);
      z-index: 999;
    }

    .nav-item {
      display: flex; align-items: center; justify-content: center; gap: 8px;
      cursor: pointer; color: #64748B; border: none; background: transparent;
      padding: 12px; border-radius: 16px; height: 48px;
      overflow: hidden; white-space: nowrap;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      flex: 1; max-width: 120px; text-decoration: none;
    }
    .nav-item.active {
      background: #1E293B; color: white;
      padding: 12px 20px; flex: 1.5; max-width: 160px;
      box-shadow: 0 8px 20px -6px rgba(30, 41, 59, 0.4);
    }
    .nav-item .material-symbols-rounded { font-size: 24px; font-variation-settings: 'FILL' 0; transition: all 0.3s; }
    .nav-item.active .material-symbols-rounded { font-variation-settings: 'FILL' 1; }
    .nav-label { display: none; font-size: 13px; font-weight: 600; }
    .nav-item.active .nav-label { display: block; }

    /* TYPING DOTS */
    .typing { display: inline-flex; gap: 4px; padding: 4px; }
    .dot { width: 6px; height: 6px; background: #94A3B8; border-radius: 50%; animation: bounce 1.4s infinite; }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

    /* =========================================
       DESKTOP RESPONSIVE STYLES (Min-Width 769px)
       ========================================= */
    @media (min-width: 769px) {
      /* REMOVE MOBILE ELEMENTS */
      .app-header, .bottom-nav { display: none; }

      /* ADJUST CHAT AREA FOR DESKTOP */
      .chat-view {
        max-width: 900px; /* Centered narrow container */
        margin: 0 auto;
        width: 100%;
        border-left: 1px solid rgba(0,0,0,0.03); /* Subtle borders */
        border-right: 1px solid rgba(0,0,0,0.03);
        box-shadow: 0 0 50px rgba(0,0,0,0.02);
      }

      /* ADJUST PADDING */
      .messages-list {
        padding: 40px 40px 100px 40px; /* Reduced bottom padding since input is lower */
      }

      /* INPUT BAR - CENTERED BOTTOM */
      .input-container {
        bottom: 30px; 
        left: 50%;
        transform: translateX(-50%);
        max-width: 700px;
        width: 90%;
      }
      .input-box:focus-within { transform: translateY(0); }
      
      /* CENTER SUGGESTIONS */
      .suggestions-scroll {
        justify-content: center;
      }
    }
  </style>
</head>

<body>
  <div class="ambient-bg"></div>

  <!-- MOBILE HEADER (Only shows on mobile) -->
  <div class="app-header">
    <div class="header-title">AI Assistant</div>

  </div>

  <!-- MAIN CONTENT -->
  <div class="chat-view">
    <div class="welcome-screen" id="welcomeScreen">
      <div class="welcome-icon">
        <span class="material-symbols-rounded">auto_awesome</span>
      </div>
      <div class="welcome-text">
        <h2>Hi, Teacher!</h2>
        <p>I can help you manage students & attendance.</p>
      </div>
      
    </div>

    <div class="messages-list" id="msgList"></div>

    <div class="input-container" id="inputContainer">
      <div class="input-box">
        <input type="text" class="input-field" id="msgInput" placeholder="Ask anything..." autocomplete="off">
        <button class="send-btn" id="sendBtn">
          <span class="material-symbols-rounded">arrow_upward</span>
        </button>
      </div>
    </div>
  </div>

  <!-- FIXED BOTTOM NAV (MOBILE ONLY) -->
  <nav class="bottom-nav">
    <a href="myclass.html" class="nav-item">
      <span class="material-symbols-rounded">home</span>
      <span class="nav-label">Home</span>
    </a>
    <a href="myclass.html#subjects" class="nav-item">
      <span class="material-symbols-rounded">menu_book</span>
      <span class="nav-label">Subjects</span>
    </a>
    <a href="myclass.html#history" class="nav-item">
      <span class="material-symbols-rounded">history</span>
      <span class="nav-label">History</span>
    </a>
    <a href="ai-assistant.html" class="nav-item active">
      <span class="material-symbols-rounded">auto_awesome</span>
      <span class="nav-label">AI</span>
    </a>
  </nav>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { firebaseConfig } from './firebase-config.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    
    function getInitials(name) {
      return name ? name.split(" ").map(n=>n[0]).join("").substring(0,2).toUpperCase() : "IT";
    }

    onAuthStateChanged(auth, user => { 
      if (!user) window.location.href='login.html'; 
      else {
        const name = user.displayName || "Teacher";
        const initials = getInitials(name);
        if(document.getElementById('headerAvatar')) document.getElementById('headerAvatar').textContent = initials;
      }
    });
  </script>

 <script>
  // ====================================
  // API CONFIGURATION
  // ====================================
  const API_CONFIG = {
    // Auto-detect environment
    isDevelopment: window.location.hostname === 'localhost' || 
                    window.location.hostname === '127.0.0.1' ||
                    window.location.hostname.includes('192.168'),
    
    // API Base URLs
    development: 'http://localhost:5000',  // Your local backend
    production: window.location.origin,     // Same origin in production
    
    // Endpoints
    endpoints: {
      chat: '/api/chatbot/chat'
    }
  };

  // Get current API base URL
  const API_BASE_URL = API_CONFIG.isDevelopment 
    ? API_CONFIG.development 
    : API_CONFIG.production;

  console.log('ðŸŒ API Base URL:', API_BASE_URL);

  // ====================================
  // CHAT FUNCTIONALITY
  // ====================================
  const msgList = document.getElementById('msgList');
  const input = document.getElementById('msgInput');
  const btn = document.getElementById('sendBtn');
  const welcome = document.getElementById('welcomeScreen');
  
  let isFirst = true;

  function scrollToBottom() {
    setTimeout(() => {
      msgList.scrollTo({ top: msgList.scrollHeight, behavior: 'smooth' });
    }, 50);
  }

  function ask(txt) {
    input.value = txt;
    send();
  }

  function addMsg(html, type) {
    const div = document.createElement('div');
    div.className = `msg msg-${type}`;
    div.innerHTML = `<div class="bubble">${html}</div>`;
    msgList.appendChild(div);
    scrollToBottom();
  }

  function showTyping() {
    const div = document.createElement('div');
    div.className = 'msg msg-ai';
    div.id = 'typing';
    div.innerHTML = `<div class="bubble"><div class="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>`;
    msgList.appendChild(div);
    scrollToBottom();
  }

  function hideTyping() {
    const el = document.getElementById('typing');
    if(el) el.remove();
  }

  async function send() {
    const txt = input.value.trim();
    if(!txt) return;

    if(isFirst) {
      welcome.style.opacity = '0';
      setTimeout(() => welcome.style.display = 'none', 300);
      msgList.classList.add('active');
      isFirst = false;
    }

    input.value = '';
    input.blur(); 
    
    addMsg(txt.replace(/</g, "&lt;"), 'user');
    showTyping();

    try {
      // Use API_BASE_URL + endpoint
      const res = await fetch(`${API_BASE_URL}${API_CONFIG.endpoints.chat}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ question: txt })
      });
      
      const data = await res.json();
      hideTyping();

      if(data.success) {
        let content = data.answer;
        if(typeof marked !== 'undefined') content = marked.parse(content);
        addMsg(content, 'ai');
      } else {
        addMsg('âŒ Error: ' + (data.error || 'Unknown'), 'ai');
      }
    } catch(e) {
      hideTyping();
      console.error('API Error:', e);
      addMsg('âš ï¸ Connection failed. Please check if the backend is running.', 'ai');
    }
  }

  btn.onclick = send;
  input.onkeypress = (e) => { if(e.key === 'Enter') send(); };
  window.ask = ask;
</script>

</body>
</html>
